---
title: "Exploring States of Tobacco-Use with Sankey Plots"
author: "R package build"
date: '2021-05-20'
slug: exploring-states-of-tobacco-use-with-sankey-plots
categories:
- data-analysis
- data-visualization
tags: []
description: ''
---

```{css, echo=FALSE}
img {
    display: block;
  margin-left: auto;
  margin-right: auto;
  
}
```

```{r include = FALSE}
library(tidyverse)
library(widgetframe)
library(DT)
          
```
# Introduction
While working toward my master's degree in applied statistics, I interned at the [Tobacco Research Lab](https://publichealth.nyu.edu/research-scholarship/centers-labs-initiatives/tobacco-research-lab) at NYU's College of Global Public Health.  During my internship, I collaborated with another researcher to study changing smoking states over time.  We were interested in answering questions such as what proportion of cigarette smokers quit and what proportion of former smokers relapse.

We began our project by focusing on descriptive statistics and data visualization.  To represent changes in smoking behavior over time, we used a data visualization technique called a Sankey diagram.  I will be mainly focusing on Sankey diagrams in this post; however, I will also cover some background on the Population Assessment of Tobacco and Health (PATH) study. 

# Required R Skills
Preparing the data required some data manipulation.  I used some basic tidyverse functions to accomplish this.  You can find many online tutorials on R and the collection of packages in the tidyverse. 


# About the PATH Study and Data 
The [PATH study ](https://pathstudyinfo.nih.gov/) is a longitudinal study of tobacco use and attitudes funded by the National Institute of Health (NIH) and the Food and Drug Administation (FDA).The study began in 2013 and has aimed to follow the same respondents across multiple waves.  The fourth and most recent wave ended in January of 2018.  According to the [FDA's website](https://www.fda.gov/tobacco-products/research/fda-and-nih-study-population-assessment-tobacco-and-health),  one of its goals of is to "study patterns of tobacco product use, cessation, and relapse", which aligned well with the focus of my internship.  

# States of Tobacco Use
The PATH survey offers a number of ways to classify smokers.  For my internship, we focused on five states of cigarette smoking/cessation.

#### Smoking Behavior Classifications
1. Current Established Smoker
2. Former Established Smoker
3. Current Experimental Smoker
4. Former Experimental Smoker
5. Non Smoker 

The non-smoker category is self-explanatory, but the other ones may require some explanation.

#### Established vs. Experimental Smokers
Established smokers were classified as respondents who reported to have smoked at least 100 cigarettes in their lifetime.  Experimental smokers were those who reported smoking between 1 and 99 cigarettes in their lifetime.

#### Current vs. Former Smokers
Current smokers were those who reported currently smoking everyday or some days.   Former smokers were those who had reported smoking at least one cigarette in their lifetime but not smoking currently. 

# Our Goal
Our first goal was  to create a Sankey Diagram to visualize these transitions across the three waves of data that were available at the time my internship. 

# A Brief History of Sankey Diagrams

[Sankey diagrams](https://en.wikipedia.org/wiki/Sankey_diagram#:~:text=Sankey%20diagrams%20are%20a%20type,proportional%20to%20the%20flow%20rate.&text=Sankey%20diagrams%20emphasize%20the%20major,quantities%20within%20defined%20system%20boundaries) are a type of flow chart to model transitions over time.  In a Sankey diagram, the proportions of each flow are represented through the width of the arrows. 

Sankey diagrams are named after Captain Matthew Henry Phineas Riall Sankey, https://en.wikipedia.org/wiki/Sankey_diagram, an Irish engineer, who created a diagram of the flow of steam through an engine in 1898.  Below is the Steam Engine diagram he created. 

```{r echo=FALSE, out.width = "300px", out.height = "400px", fig.align= "center", fig.cap= "Original Sankey Diagram (Source: Wikipedia)"}
##![Sankey's Original Steam Engine Diagram](/img/steam_engine_sankey.png){width=80%}
knitr::include_graphics("/img/steam_engine_sankey.png",error =FALSE)

```

Another famous example was created by Charles Minard almost 30 years earlier.  Minard's diagram shows the movement of Napoleon's army during his 1812 Russian campaign. In the visualization, the width of the arrow becomes thinner as casualties and desertions diminishes the size of Napoleon's army.

```{r echo=FALSE, fig.cap="Sankey Diagram of Napoleon's Russian Campaign (Source: Wikipedia)", fig.align="center"}
##![Sankey's Original Steam Engine Diagram](/img/steam_engine_sankey.png){width=80%}
knitr::include_graphics("/img/Minard.png",error =FALSE)

```

# Getting the Data in Shape

To create our own Sankey diagram, we decided to use [Flourish Studio](https://flourish.studio/).   Flourish offers a variety of visualizations.  Flourish actually offers three types of Sankey diagrams: default, multi-step alluvial, and multi-step Sankey. We chose the multi-step alluvial Sankey because each flow is measured at the same time points, i.e. each wave of the survey.   

Before uploading our dataset, we needed to structure it to fit Flourish's specifications.  This is where R comes in handy. The Sankey Diagram dataset should have the following five columns. 

#### Dataset Columns 
<ul>
  <li> **Column A:** Represents the source of the flow.  </li>
  <li> **Column B:**  Represents the target of the flow. </li>
  <li> **Column C:** Represents the Value, which could be the number or proportion of units flowing from the source to the destination at a given point in time . </li>
  <li> **ColumnD:** Represents the Step From.  This indicates the time point of the Source Column.  </li>
  <li> **Column E:** Represents the Step To.  This indicates the time point of the Target column.</li>
</ul>

Each row in the dataset represents a unique flow or arrow between two waves of the study.  Below is an example of how the data should be structured.

```{r echo = FALSE}

# Note:s Can Use DT here 
dta <- data.frame(Source = c('Non-Smoker', 'Non-Smoker',
                              'Current Est. Smoker',  'Current, Est. Smoker',
                             'Non-Smoker', 'Non-Smoker',
                             'Current Est. Smoker', 'Current Est. Smoker',
                             'Former Est. Smoker', 'Former Est. Smoker'),
                  Target = c( 'Non-Smoker', 'Current Est. Smoker',
                             'Current Est Smoker', 'Former Est. Smoker',
                             'Non-Smoker', 'Current Est. Smoker', 
                             'Current Est. Smoker', 'Former Est. Smoker',
                             'Former Est. Smoker', 'Current Est. Smoker'),
                  Value = c(2000, 1000, 1200, 900, 
                            1400, 600, 1800, 400, 800, 100),
                  Step_from = c(rep(1, 4), rep(2, 6)),
                  Step_to=  c(rep(2, 4), rep(3, 6))
)
dta %>%  DT::datatable()  %>%  widgetframe::frameWidget()

#?datatable
#?frameWidget
```



In the example table, there were 3,000 non-smokers in wave 1 (Rows 1 and 2).  Of these 3,000 non-smokers, 2,000 remained non-smokers in wave 2 and 1,000 became Current Established Smokers.  In Wave 2, there were 2,200 current established smokers (Rows 7 and 8).  Of these participants, 1,800 remained current established smokers in Wave 3 and 400 became former smokers. 


### Constructing and Loading PATH Dathset
So now it's time to go back to our path data.  I constructed the adult_panel dataset by merging together the first three waves of the study *(Note: The fourth wave of the study was not available during the time of my internship)*.  I also constructed a smoking status variable for each wave based on our five smoking behavior classifications. 
 
```{r load_adult_panel}
dta_raw <- read.csv("../../../data/adult_panel.csv", stringsAsFactors = TRUE) 

dta <- dta_raw %>% 
  dplyr::select(PERSONID, starts_with('smoking_status_full')) %>% 
  tidyr::drop_na() 

glimpse(dta)

```

I've only kept complete cases, i.e. adults who participated in all of the first three waves of the study.  I did this for simplicity.  However, it's important to note that to make valid inferences to the actual general population, we would need to adjust these numbers using survey weights contained in the original files.  Additionally, the survey weights would allow us to adjust for item non-response and attrition.  In the future, I plan to create another diagram that adjusts the proportions by the survey weights.  In the meantime, this Sankey diagram will help give us a rough estimate of smoking transition over time and allow us to demonstrate the steps needed to construct a Sankey Diagram on Flourish Studio   


### Transposing Data
Now that we've loaded the data into R, we need to transpose the dataset into a "long" format.  In the long-form dataset, each row should represent  respondent's smoking status in a particular year.  We can use the pivot_longer() from the tidyverse library.  By setting the cols parameter to "- PERSONID", pivot all the columns to a long format except the PERSONID column.  Now the "name" column represents the original variable name and the value represents the status for each of thos variables.   Notice that the first three columns represents the smoking status of respondent "P000000004" across the first three waves of the study.  We can observe that this person reported being a "never smoker" throughout the study. 

```{r dta_transpose}
dta_long <- dta %>%  
              tidyr::pivot_longer(cols = - PERSONID) 
dta_long %>%  head


```

Next we need to convert the "name" column into an integer.  I ucan se the string subset command to extract the wave number from the "name" column.  Finally, we can delete the original name column because I know all the data in the "value" column refers to smoking statuses. 

```{r dta_convert_wave_to_integer}
dta_long <- dta_long %>% 
              dplyr::mutate(wave = as.integer(str_sub(name, -1))) %>% 
              dplyr::select(-name)

dta_long %>%  head

```

#### Source Data Subset
The next step is to create to separate datasets: one for the source and one for the target.  I can create the source dataset by dropping the latest wave.  I then rename the value variable to "source" wave variable to "step_from".  The rows in this dataset represent a particular state in the dataset from which we will "step" to another stage.  For that reason, we need to exclude the latest wave of data because we don't have any other stage to advance to from.
```{r dta_source}
#drop the last wave
dta_source <- dta_long %>% 
                dplyr::filter(wave != max(wave)) %>% 
                rename(source = value,
                       step_from = wave)
dta_source %>%  head
```

####Target Dataset
Next I created a "Target" dataset, which is basically the next stage to which we will advance. We can create this dataset by dropping the first wave from the dataset.

```{r dta_target}
#Drop first wave
dta_target <- dta_long %>% 
              dplyr::filter(wave != 1) %>% 
              rename(target = value,
                     step_to = wave)

dta_target %>%  head
```

### Merging the Datasets

Now we can merge the Source and  Target datasets by PERSONID.  We can use the logical expresion "step_to - step_from == 1" to ensure that each row represents a transition across *consecutive* waves.  We want the transitions between waves 1 and 2 and waves 2 and 3, but we want to exclude the transitions between waves 1 and 3. 

```{r merge_source_target_data}
dta_sankey <- dta_source %>% 
                inner_join(dta_target, by = 'PERSONID') %>% 
                dplyr::select(PERSONID, source, target, step_from, step_to) %>%   
                filter(step_to - step_from== 1)

dta_sankey %>%  head

```


#### Examples of Transitions
Here we can see six respondents who never smoked at wave 1 but became current established smokers by wave 2.

```{r}
dta_sankey %>%  
  filter(source =='never_smoker' & dest == 'current_est_smoker' & step_from == 1  & step_to ==2)  %>% 
  head
```

Here we can see six respondents who were  current established  smokers at wave 2 but became former smokers by wave 3..

```{r}
dta_sankey %>%  
  filter(source =='current_est_smoker' & dest == 'former_est_smoker' & 
           step_from == 2  & step_to ==3)  %>% 
  head
```
 Note that some smoking transitions are impossible.  For example, no established or experimental smoker can become a never smoker again.  
 
```{r}
dta_sankey %>%  
  filter(source %in% c('current_est_smoker', 
                       'former_est_smoker', 
                       'current_exp_smoker', 
                       'former_exp_smoker'),
         dest == 'never_smoker') 
```
 
Furthermore, established smokers can never become experimental smokers again.  Once you've passed the 100-cigarette threshold, there's no way to go back. 

```{r}
dta_sankey %>%  
  filter(source %in% c('current_est_smoker', 'former_est_smoker'),
         dest == c('current_exp_smoker', 'former_exp_smoker') )
```

However, never smokers can become experiment smokers and experimental smokers can become established. 

```{r}
dta_sankey %>% 
  filter(source == 'current_exp_smoker', dest == 'current_est_smoker') %>% 
  head
```

In addition, you can transition back and forth between being a former smoker and current smoker.


```{r}
dta_sankey %>% 
  filter(str_detect(source, 'est_smoker$'), str_detect(dest, 'est_smoker$'), source != dest) %>% 
  head()
```

### Grouping and Summarizing the Datass
The final step before uploading the data is aggregate the data.  The dataset should not be individual-level dataset but at the level of each transition type.  I've also pasted "Wave" in front of the step_to and step_from variables.  This will make our headings clearer when we create our Sankey Diagram.
``````{r}
dta_sankey_cnt <-dta_sankey %>% 
                    group_by(source,dest, step_from, step_to) %>% 
                    summarize(value =n(), .groups = "rowwise") %>% 
                    dplyr::select(source, dest, value, step_from, step_to)
              

sankey_tab <- dta_sankey_cnt %>% 
  arrange(step_from, step_to) %>% 
  DT::datatable() 

widgetframe::frameWidget(sankey_tab )
```

Note here that there are 34 rows.  Each row represents a transition between two smoking states across two consequent waves. The number in the value column indicates the number of respondents.   For example, there were 889 respondents who went from being "current established smokers" to "former established smokers" from wave 1 to wave 2 (indicated by the step_to and step_from columns).   Notice also that the source can be equal to the destination for respondents who remained in the same smoking state across two consecutive waves of the study.  In fact, we'll see from the sankey plot, that this is the most likely scenario for respondents in our study!. 

# Exporting and Uploading Data to Flourish Studio

Now that our data is in the shape we need, we can upload it to Flourish studio. sFirst we can use export the data as a csv file.

```{r export_data}
write_csv(dta_sankey_cnt, "../../../data/path_sankey.csv")
```
Next we can log on to our Flourish studio account and click the muti-stage alluvial plot under the Sankey Diagram visualiztion.  In the next agep, click the data button above the diagram.  Then click the "Upload Data' on the right.  Finally, select the file containing your data.  

If you arranged the dataset in ordre (Source, Tareget, Value, Step From, Step to), Flourish should automatically recognize.  You can use the control panel in the sidebar to make any necessary corrections.  If everything looks okay, click the "preview" button. 

And voila, we now have a Sankey plot!  

<div class="flourish-embed flourish-sankey" data-src="visualisation/6249967"><script src="https://public.flourish.studio/resources/embed.js"></script></div>

We can give our Sankey plot a name by clicking on the top of the page.  Finally, we can click "Export & publish" on the upper right.  You have the options of downloading your diagram or publishing it.  Only publish  your diagram if you're sure that the diagram does not contain any sensitive infomration (Note: that there is an option to require a password but this is only available with Flourish's paid business account).  

## Use our Sankey Diagram to Explore Cigarette-Use over Time

The first thing I noticed was that the thickest line from each state flows the same state in the next wave.  Your most likely state in the next wave of the study is your state in the current wave of the study. 

Another thing that I noticed was that the "never smokers" line seems to be the most consistent.  Never smokers in wave 1 tended to stay never smokers in waves 2 and 3.  This probably reflects the fact that all respondents were over the age of 18 during the first wave of the study.  Adults who are never smokers do not tend to take up smoking later in life.  For this reason, it would also be interesting to explore the Youth survey to investigate how respondents under the age of 18 started to experiment with cigarette stating.

Another thing I thought would be interesting is to explore relapse rates among former established smokers over time.  From wave 1 to wave 2 about 12% (432 out 3,607) of former established smokers relapsed.  About the same proportion (12.4% or 521 out of 4,437 to be exact) relapsed between waves 2 and 3.  We could use multi-state to investigate the over risk of relapse at a given wave. 




# Appendix

## Original Datasets

You can download the public-use datasets [here](https://www.icpsr.umich.edu/web/NAHDAP/studies/36498).

The files DS1001, DS2001, DS3001, and DS4001 correspond to waves 1 through 4 of the adult survey. 

Once you download these datasets you can merge them by the variable PERSONID. This creates a "wide" dataset in which each column contained a particular variable from a single wave.  In my *adult_panel* dataset, I added a suffixes (w1, w2, w3) indicating which wave each variable comes from.The original variable names include the prefix R01, R02, R03, and R04 where "R" refers to the adult survey and the numbers refer to the particular wave.  

#### Original Variables 
The dataset includes the original questions used to derive each smoking category as well as series of derived indicator variables for each category.
1. R01R_A_CUR_ESTD_CIGS: Wave 1 Current Established Smokers 
2. R01R_A_CUR_EXPR_CIGS: Wave 1 Current Experimental Smokers
3. R01R_A_FMR_ESTD_CIGS: Wave 1 Former Established Smokers 
4. R01R_A_FMR_EXPR_CIGS: Wave 1 Former Experimental Smokers

The variables in the other datasets have the same name with the number after the initial "R" representing the wave of the study.  The only other differncee  is that the wave 2 and wave 3 "former" smoker categories have a "_REV" suffix, e.g. R02R_A_FMR_ESTD_CIGS_REV represents wave 2 former established smokers. 

To find wave 1 never smokers, you can use the variable R01R_A_NVR_CIGS.  To find never smokers in waves 2 and 3, you can use the completment of R02R_A_EVR_CIGS and   R03R_A_EVR_CIGS.

The dataset also includes indicators for whether  a person was "continuing adult" in a given wave of the study.   However, we can use a inner join to constrain our sample to include only adults from wave 1 who responded in each subsequent wave.  

## Survey Weighting
Finally, the survey actually has a series of weights to adjust for both attrition and non-representativeness of the sample.  The weights take into account several factors.

 1. The complex sampling design.  As in most surveys, the PATH study used both stratification and clustering sampling methods instead of simple random sampling.  
 2. Intentional oversampling.  The PATH survey intentionally over samples people between the ages of 18 and 34, African-American adults, and 
 3.Non-response bias.   The characteristics of respondents may not reflect the population because not everyone 
 4. Attrition between waves
 
 You can learn more about the survey weighting process [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5299069/). 
 
### Multi-state Modeling
Multi-state modeling is a good tool for estimating the probability of transitioning[Therneau, Crowson, & Atkinson, 2021](https://cran.r-project.org/web/packages/survival/vignettes/compete.pdf]).  Multi-state modeling is essentially a generalization of survival analysis (ibid).  In survival analysis there only two stages, life and death, and you can only transition from the first state to the second. However, in multi-state modeling there can be more than two states and it can be possible to revert.  For example, if we focus cigarette smoking, we can imagine the five states that we used for our Sankey diagram.  In this model, it would be possible to transition back and forth between some states such as between current established smoker and former established smoker. The major assumption is that the the 

**Example of Transition Matrix**
```{r}
mat <- matrix(c('p11', 'p12', 'p13', 'p21', 'p22', 'p23', '0', '0', 'p33'), ncol=3)
rownames(mat) <- c('Current Smoker', 'Former Smoker', 'Never Smoker')
colnames(mat)  <- c('Current Smoker', 'Former Smoker', 'Never Smoker')
mat
```
*Example of Transition Matrix*

The row names represent the state in a wave (*t*) and the column names represent the state in the next wave (*t+1*).  I've removed the established vs. experimental distinction in order to simplify the matrix.  Each element within represents the probability of transitioning from one state to the next between two waves of the study.  For example, p21 represents the probability of a current smoker becoming a former smoker from time *t* to time *t + 1*.  Notice that the first two rows in the third column are equal to zero because current and former smokers cannot become never smokers again.  

Although this example would be an example of discrete-time, multi-state models can also be used in continuous cases.  Also the most common assumptions is these models are that transition probabilities only depend on the current state [Meira-Machado et. al, 2009](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2692556/#:~:text=The%20analysis%20in%20such%20studies,a%20finite%20number%20of%20states.&text=A%20change%20of%20state%20is%20called%20a%20transition%2C%20or%20an%20event).


## Next Steps
I additional ideas of things to do with the PATH data.  Some of these would be building on the work that I already did during my internship and other ones would be charting new territory. 

 1. Add wave 4 data
 2. Create another Sankey Plot using survey weights
 3. Create a tutorial about how to use the surveyR package with PATH data
 4. Fit a multinomial logistic regression to explore smoking transitions across two waves of the study
 5. Use multi-state modeling to investigate probabilities of smoking transitional states across multiple waves



